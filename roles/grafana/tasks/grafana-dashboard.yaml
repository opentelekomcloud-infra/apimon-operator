- name: Print 
  debug:
#    msg: "{{ grafana_config_dashboard_exists.data['dashboard.json'] }}"
    msg: "{{ grafana_secret_exists.data['GF_SECURITY_ADMIN_PASSWORD'] }}"

- name: create temp directory
  tempfile:
    state: directory
    suffix: grafana_dashboard
  register: temp_dir

- name: Generate destination
  set_fact:
    dashboard_dest: "{{ (temp_dir.path + '/dashboard.json') }}"

- name: Write dashboard content to file
  copy:
    content: "{{ grafana_config_dashboard_exists.data['dashboard.json'] }}"
    dest: "{{ dashboard_dest }}"

- name: Add dashboard
  grafana_dashboard:
    grafana_url: "{{ ('https://' + fqdn |string) }}"
    grafana_user: "admin"
    grafana_password: "{{ grafana_secret_exists.data['GF_SECURITY_ADMIN_PASSWORD'] | b64decode }}"
    state: present
    path: "{{ dashboard_dest }}"
    validate_certs: no
    overwrite: yes

- name: Remove temp dir
  file:
    path: "{{ temp_dir.path }}"
    state: absent
  when: temp_dir.path is defined

